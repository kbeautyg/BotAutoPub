#!/usr/bin/env python3
"""
–¢–µ—Å—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è caption
"""

import sys
sys.path.append('/app')

from auto_post_fixed import prepare_media_text_smart, prepare_media_text

def test_caption_length_handling():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª–∏–Ω–Ω—ã—Ö caption —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    
    print("üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –û–ë–†–ê–ë–û–¢–ö–ò –î–õ–ò–ù–ù–´–• CAPTION")
    print("=" * 60)
    
    # –¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–æ–±–ª–µ–º–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏ - –¥–ª–∏–Ω–Ω—ã–π
    long_text = """üéâ –ù–û–í–û–°–¢–¨: –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã KBeautyGuide!

–î—Ä—É–∑—å—è, –º—ã –¥–æ–ª–≥–æ –∂–¥–∞–ª–∏ —ç—Ç–æ—Ç –¥–µ–Ω—å ‚Äî —Ç–µ–ø–µ—Ä—å —É —Ç–µ–±—è –µ—Å—Ç—å —à–∞–Ω—Å –Ω–µ —Ç–æ–ª—å–∫–æ —ç–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞ –ª—é–±–∏–º–æ–π –∫–æ—Ä–µ–π—Å–∫–æ–π –∫–æ—Å–º–µ—Ç–∏–∫–µ, –Ω–æ –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤–º–µ—Å—Ç–µ —Å –Ω–∞—à–∏–º —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º! üòç

üíé –î–ª—è –∫–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞?
- –î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Ç–µ—Ö, –∫—Ç–æ –ª—é–±–∏—Ç –¥–µ–ª–∏—Ç—å—Å—è –Ω–∞—Ö–æ–¥–∫–∞–º–∏
- –ï—Å–ª–∏ —Ç—ã —á–∞—Å—Ç–æ –∑–∞–∫–∞–∑—ã–≤–∞–µ—à—å –¥–ª—è —Å–µ–±—è/–¥—Ä—É–∑–µ–π ‚Äî —Ç–µ–±–µ —Ç–æ—á–Ω–æ –∫ –Ω–∞–º!

‚ú® –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–∞:
üë• –£—á–∞—Å—Ç–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —á–ª–µ–Ω–æ–≤ –Ω–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ ‚Äî –æ—â—É—â–∞–π —Å–µ–±—è –≤ –∫–ª—É–±–µ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö  
üí∞ –ë–æ–Ω—É—Å—ã –∑–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –æ–ø—Ç–æ–≤—ã–µ –∑–∞–∫—É–ø–∫–∏  
üåè 100% –æ—Ä–∏–≥–∏–Ω–∞–ª –∏–∑ –ö–æ—Ä–µ–∏ ‚Äî –ª–∏—á–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –°–µ—É–ª–µ  
üî• –í—ã–≥–æ–¥–Ω–æ –∏ –Ω–∞–¥—ë–∂–Ω–æ ‚Äî –Ω–æ–ª—å –ø–µ—Ä–µ–ø–ª–∞—Ç –∏ —Ä–∏—Å–∫–æ–≤  
üöÄ –°–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –Ω–æ–≤–∏–Ω–∫–∏ –∏ —Ç—Ä–µ–Ω–¥—ã –¥–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤

üìå –£—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è –ø—Ä–æ—Å—Ç—ã–µ, –∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–æ—Å—Ç–∞ ‚Äî –±–µ–∑–≥—Ä–∞–Ω–∏—á–Ω—ã–µ! –°—Ç–∞–Ω—å —á–∞—Å—Ç—å—é –∫–æ–º–∞–Ω–¥—ã –∏ —Ä–∞–∑–≤–∏–≤–∞–π KBeautyGuide –≤–º–µ—Å—Ç–µ —Å –Ω–∞–º–∏. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —É–∂–µ –∑–∞–∫—É–ø–∞–µ—Ç—Å—è ¬´–Ω–∞ —Ç—Ä–æ–∏—Ö¬ª –∏–ª–∏ —Ö–æ—á–µ—Ç —Å–¥–µ–ª–∞—Ç—å –±—å—é—Ç–∏-—É–≤–ª–µ—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –¥–æ—Ö–æ–¥–∞.

üëâ –•–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å –¥–µ—Ç–∞–ª–∏? –ü–∏—à–∏ –≤ –ª–∏—á–∫—É ‚Äî —Ä–∞—Å—Å–∫–∞–∂—É –≤—Å—ë, –ø–æ–¥—Å–∫–∞–∂—É –∏ –ø–æ–º–æ–≥—É —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å!

#KGG_–ü–∞—Ä—Ç–Ω–µ—Ä—ã #KGG_–°–æ–æ–±—â–µ—Å—Ç–≤–æ #–ü–æ–ª–µ–∑–Ω–æ–µ–û—ÇKBG"""

    print(f"üìù –ò–°–•–û–î–ù–´–ô –¢–ï–ö–°–¢:")
    print(f"–î–ª–∏–Ω–∞: {len(long_text)} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"–ü—Ä–µ–≤—å—é: {long_text[:150]}...")
    print("\n" + "-" * 50)
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã –ø–∞—Ä—Å–∏–Ω–≥–∞
    parse_modes = [
        ("MarkdownV2", "Markdown —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º"),
        ("HTML", "HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"),
        (None, "–ë–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
    ]
    
    for parse_mode, description in parse_modes:
        print(f"\nüîÑ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï: {description}")
        
        try:
            # –£–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
            smart_caption, smart_additional = prepare_media_text_smart(
                long_text, 
                parse_mode, 
                max_caption_length=1024
            )
            
            print(f"‚úÖ –£–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:")
            print(f"   Caption –¥–ª–∏–Ω–∞: {len(smart_caption)} —Å–∏–º–≤–æ–ª–æ–≤")
            print(f"   –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç: {len(smart_additional)} —Å–∏–º–≤–æ–ª–æ–≤")
            print(f"   Caption –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞: {len(smart_caption) <= 1024}")
            
            if len(smart_caption) > 100:
                print(f"   Caption –ø—Ä–µ–≤—å—é: {smart_caption[:100]}...")
            else:
                print(f"   Caption: {smart_caption}")
            
            # –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            old_caption, old_additional = prepare_media_text(long_text, max_caption_length=800)
            
            print(f"\nüìä –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è):")
            print(f"   Caption –¥–ª–∏–Ω–∞: {len(old_caption)} —Å–∏–º–≤–æ–ª–æ–≤")
            print(f"   –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç: {len(old_additional)} —Å–∏–º–≤–æ–ª–æ–≤")
            
        except Exception as e:
            print(f"‚ùå –û–®–ò–ë–ö–ê: {e}")
        
        print("-" * 40)
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ –¥–ª–∏–Ω–∞–º–∏
    print(f"\nüéØ –¢–ï–°–¢–´ –° –†–ê–ó–ù–û–ô –î–õ–ò–ù–û–ô:")
    
    test_lengths = [
        ("–ö–æ—Ä–æ—Ç–∫–∏–π", "–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."),
        ("–°—Ä–µ–¥–Ω–∏–π", "–≠—Ç–æ —Ç–µ–∫—Å—Ç —Å—Ä–µ–¥–Ω–µ–π –¥–ª–∏–Ω—ã —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏: —Ç–æ—á–∫–∏, –¥–µ—Ñ–∏—Å—ã - –∏ —Å–∫–æ–±–∫–∏ (—Ç–µ—Å—Ç)! " * 3),
        ("–î–ª–∏–Ω–Ω—ã–π", long_text)
    ]
    
    for length_name, test_text in test_lengths:
        print(f"\nüìã {length_name} —Ç–µ–∫—Å—Ç ({len(test_text)} —Å–∏–º–≤–æ–ª–æ–≤):")
        
        try:
            caption, additional = prepare_media_text_smart(test_text, "MarkdownV2", max_caption_length=1024)
            
            print(f"   ‚úÖ Caption: {len(caption)} —Å–∏–º–≤–æ–ª–æ–≤")
            print(f"   ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π: {len(additional)} —Å–∏–º–≤–æ–ª–æ–≤")
            print(f"   ‚úÖ –í –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞: {len(caption) <= 1024}")
            
            if len(caption) > 50:
                print(f"   –ü—Ä–µ–≤—å—é: {caption[:50]}...")
            
        except Exception as e:
            print(f"   ‚ùå –û—à–∏–±–∫–∞: {e}")
    
    print(f"\n" + "=" * 60)
    print("üèÅ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û")

if __name__ == "__main__":
    test_caption_length_handling()